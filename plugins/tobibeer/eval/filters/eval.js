/*\
title: $:/plugins/tobibeer/eval/filters/eval.js
type: application/javascript
module-type: filteroperator

a filter to compute and compare numbers, booleans and dates

@preserve
\*/
(function(){"use strict";var e=require("$:/plugins/tobibeer/eval/lib.js"),i=e.getLibrary("$:/plugins/tobibeer/eval/libraries");if(i&&i.jsWarning){console.log("Warning eval filter: no math.js found, running in javascript eval mode!")}exports.eval=function(e,r,t){var l,n,a,f,s,u,d,o,p={},v={not:[]},c=t.widget,b=c?c.getVariable("currentTiddler"):"",g=/^\s*([\w\d\/]*):(.*)(?:\s*)$/,m=/^\s*\$([\w]*)(?:\s*)$/,x=t.wiki;try{s=m.exec(r.suffix||"");if(s&&!u){u=s[1]?s[1]:"any";v[u]=[]}$tw.utils.each((r.operand||"").split("\\"),function(e){if(e){s=g.exec(e);if(s){p[s[1]]=s[2]}else if(n===undefined){n=e}}});if(p.lib){f=p.lib.trim().split(" ");p.lib=x.getLibrary({type:f[0],id:f[1]?f[1]:undefined})}else{p.lib=i}if(!p.lib||!p.lib.eval){throw"No suitable library configured."}n=n||"";$tw.utils.each(Object.keys(p),function(e){if(["current","if","final","format","lib"].indexOf(e)<0){l=x.parseExpressionReferences(p[e],{widget:c,tiddler:b});o=p.lib.eval(l);p[e]=o===undefined?0:o}});if(p.format){if(i.format){if(p.format.indexOf(":")>=0){a=("{"+p.format+"}").replace(/[\'\"]/g,'"').replace(/(\w+):/g,'"$1":');p.format=JSON.parse(a)}}else{p.format=undefined}}p.value=p.init===undefined?0:p.init;if(n||p.value||p.final!==undefined){e(function(e,r){p.title=r;var t=p.current?p.current.replace(/%title%/gm,p.title):"";l=x.parseExpression(n,{widget:c,tiddler:r,vars:p,title:r,references:true});o=p.lib.eval(l.trim());p.value=o;if(p.format&&(v.val||v.eq)){o=o?i.format(o,p.format):o}if(v.val){v.val.push(o+t)}if(o){if(v.any){v.any.push(r)}}else{v.not.push(r)}if(v.all){v.all.push(r)}if(v.expr){v.expr.push(l+t)}if(v.eq){v.eq.push(l+" = "+o+t)}});if(p.final!==undefined){l=x.parseExpression(p.final,{widget:c,tiddler:b,vars:p,title:"",references:true});p.value=o=p.lib.eval(l);if(v.expr){v.expr.push(l)}if(v.eq){v.eq.push(l+" = "+o)}}}else{p.value="false"}if(u){d=v[u]}else{o=(p.format?i.format(p.value,p.format):p.value).toString();d=[o]}if(p.if!==undefined){l=x.parseExpression(p.if,{widget:c,tiddler:b,vars:p,references:true});o=p.lib.eval(l);if(p.value.toString()!==(o===undefined?"":o).toString()){return[]}}}catch(l){return["Error in eval filter:\n"+l]}return d}})();