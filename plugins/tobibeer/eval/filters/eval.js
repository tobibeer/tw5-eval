/*\
title: $:/plugins/tobibeer/eval/filters/eval.js
type: application/javascript
module-type: filteroperator

a filter to compute and compare numbers, booleans and dates

@preserve
\*/
(function(){"use strict";var e=require("$:/plugins/tobibeer/eval/lib.js"),i=e.getLibrary("$:/plugins/tobibeer/eval/libraries");if(i&&i.jsWarning){console.log("Warning eval filter: no math.js found, running in javascript eval mode!")}exports.eval=function(e,r,t){var n,l,a,f,s,u,o,d,p={},c={not:[]},v=t.widget,b=v?v.getVariable("currentTiddler"):"",g=/^\s*([\w\d\/]*):(.*)(?:\s*)$/,m=/^\s*\$([\w]*)(?:\s*)$/,x=t.wiki;try{s=m.exec(r.suffix||"");if(s&&!u){u=s[1]?s[1]:"any";c[u]=[]}$tw.utils.each((r.operand||"").split("\\"),function(e){if(e){s=g.exec(e);if(s){p[s[1]]=s[2]}else if(l===undefined){l=e}}});if(p.lib){f=p.lib.trim().split(" ");p.lib=x.getLibrary({type:f[0],id:f[1]?f[1]:undefined})}else{p.lib=i}if(!p.lib||!p.lib.eval){throw"No suitable library configured."}l=l||"";$tw.utils.each(Object.keys(p),function(e){if(["current","if","final","format","lib"].indexOf(e)<0){n=x.parseExpressionReferences(p[e],{widget:v,tiddler:b});d=p.lib.eval(n);p[e]=d===undefined?0:d}});if(p.format){if(i.format){if(p.format.indexOf(":")>=0){a=("{"+p.format+"}").replace(/[\'\"]/g,'"').replace(/(\w+):/g,'"$1":');p.format=JSON.parse(a)}}else{p.format=undefined}}p.value=p.init===undefined?0:p.init;if(!p.count){p.count=0}if(l||p.value||p.final!==undefined){e(function(e,r){p.count++;p.title=r;var t=p.current?p.current.replace(/%title%/gm,p.title):"";n=x.parseExpression(l,{widget:v,tiddler:r,vars:p,title:r,references:true});d=p.lib.eval(n.trim());p.value=d;if(p.format&&(c.val||c.eq)){d=d?i.format(d,p.format):d}if(c.val){c.val.push(d+t)}if(d){if(c.any){c.any.push(r)}}else{c.not.push(r)}if(c.all){c.all.push(r)}if(c.expr){c.expr.push(n+t)}if(c.eq){c.eq.push(n+" = "+d+t)}});if(p.final!==undefined){n=x.parseExpression(p.final,{widget:v,tiddler:b,vars:p,title:"",references:true});p.value=d=p.lib.eval(n);if(c.expr){c.expr.push(n)}if(c.eq){c.eq.push(n+" = "+d)}}}else{p.value="false"}if(u){o=c[u]}else{d=(p.format?i.format(p.value,p.format):p.value).toString();o=[d]}if(p.if!==undefined){n=x.parseExpression(p.if,{widget:v,tiddler:b,vars:p,references:true});d=p.lib.eval(n);if(p.value.toString()!==(d===undefined?"":d).toString()){return[]}}}catch(n){return["Error in eval filter:\n"+n]}return o}})();